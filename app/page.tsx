'use client';

import React, { useState, useEffect, useRef } from 'react';
import SignaturePad from 'signature_pad';
import ExcelJS from 'exceljs';
import { saveAs } from 'file-saver';

import { collection, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc } from "firebase/firestore";
import { db } from "../firebase";

type Trainee = {
  team: string;
  id: string;
  name: string;
  signature?: string;
};

// ---------- Firestore Í¥ÄÎ†® Ìï®Ïàò ----------
const saveSubjectsToFirebase = async (
  mode: "domestic" | "overseas",
  list: string[],
  contents: Record<string, string>
) => {
  try {
    await setDoc(
      doc(db, `config_${mode}`, `${mode}_subject`),   // üîπ Î¨∏ÏÑúÎ™ÖÏùÑ ÎèôÏ†ÅÏúºÎ°ú
      {
        subjectList: list,
        subjectContents: contents,
      }
    );
  } catch (error) {
    console.error("Error saving subjects:", error);
  }
};

  const loadSubjectsFromFirebase = async (
  mode: "domestic" | "overseas",
  setSubjectList: Function,
  setSubjectContents: Function
) => {
  try {
    const docSnap = await getDoc(
      doc(db, `config_${mode}`, `${mode}_subject`)   // üîπ Î¨∏ÏÑúÎ™ÖÏùÑ ÎèôÏ†ÅÏúºÎ°ú
    );

    if (docSnap.exists()) {
      const data = docSnap.data();
      setSubjectList(data.subjectList || []);
      setSubjectContents(data.subjectContents || {});
    } else {
      console.warn(`${mode} subject document not found`);
      setSubjectList([]);
      setSubjectContents({});
    }
  } catch (error) {
    console.error("Error loading subjects:", error);
  }
};

const saveCourseToFirebase = async (
  mode: "domestic" | "overseas",
  name: string,
  password: string,
  time: string,
  subjectName: string
) => {
  try {
    await setDoc(
      doc(db, mode === "domestic" ? "course_domestic" : "course_overseas", name),
      {
        subject: subjectName,
        time: time,
        password: password,
        createdDate: new Date().toLocaleDateString(),
        trainees: []   // Ï¥àÍ∏∞ trainee Î¶¨Ïä§Ìä∏
      }
    );
  } catch (error) {
    console.error("Error saving course:", error);
  }
};

    const loadCoursesFromFirebase = async (
  mode: "domestic" | "overseas",
  setCourseList: Function,
  setCoursePasswords: Function,
  setCourseTimePerCourse: Function,
  setCourseCreatedDates: Function,
  setTraineeListPerCourse: Function,
  setCourseSubjects: Function
) => {
  try {
    const collectionName = mode === "domestic" ? "course_domestic" : "course_overseas";
    const snapshot = await getDocs(collection(db, collectionName));

    const courseNames: string[] = [];
    const passwords: { [key: string]: string } = {};
    const times: { [key: string]: string } = {};
    const createdDates: { [key: string]: string } = {};
    const traineeMap: { [key: string]: Trainee[] } = {};
    const subjects: { [key: string]: string } = {};

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const courseName = docSnap.id;
      courseNames.push(courseName);
      passwords[courseName] = data.password || "";
      times[courseName] = data.time || "";
      createdDates[courseName] = data.createdDate || "";
      traineeMap[courseName] = data.trainees || [];
      subjects[courseName] = data.subject || "";
    });

    setCourseList(courseNames);
    setCoursePasswords(passwords);
    setCourseTimePerCourse(times);
    setCourseCreatedDates(createdDates);
    setTraineeListPerCourse(traineeMap);
    setCourseSubjects(subjects);
  } catch (error) {
    console.error("Error loading courses:", error);
  }
};

  const saveTraineesToFirebase = async (
  mode: "domestic" | "overseas",
  courseName: string,
  trainees: Trainee[]
) => {
  const courseRef = doc(
    db,
    mode === "domestic" ? "course_domestic" : "course_overseas",
    courseName
  );
  await updateDoc(courseRef, { trainees });
};

// ---------- Î©îÏù∏ Ïª¥Ìè¨ÎÑåÌä∏ ----------
export default function Home() {
  const [selectedMode, setSelectedMode] = useState<"domestic" | "overseas" | null>(null);

  const [screen, setScreen] = useState<'main' | 'adminHome' | 'createCourse' | 'editCourse' | 'instructor' | 'traineeList'>('main');
  const [showAdminAuth, setShowAdminAuth] = useState(false);
  const [adminCode, setAdminCode] = useState('');
  const ADMIN_PASSWORD = '1234';

  const [showInstructorAuth, setShowInstructorAuth] = useState(false);
  const [instructorCode, setInstructorCode] = useState('');
 
  const [courseList, setCourseList] = useState<string[]>([]);
  const [coursePasswords, setCoursePasswords] = useState<{ [course: string]: string }>({});
  const [courseCreatedDates, setCourseCreatedDates] = useState<{ [course: string]: string }>({});
  const [courseTimePerCourse, setCourseTimePerCourse] = useState<{ [course: string]: string }>({});
  const [courseSubjects, setCourseSubjects] = useState<{ [course: string]: string }>({});
  const [traineeListPerCourse, setTraineeListPerCourse] = useState<{ [course: string]: Trainee[] }>({});

  const [subjectList, setSubjectList] = useState<string[]>([]);
  const [subjectContents, setSubjectContents] = useState<{ [key: string]: string }>({});
  const [newSubjectName, setNewSubjectName] = useState('');
  const [subjectContent, setSubjectContent] = useState('');
  const [selectedSubjectToEdit, setSelectedSubjectToEdit] = useState('');

  const [selectedCourse, setSelectedCourse] = useState('');
  const [newCourseName, setNewCourseName] = useState('');
  const [newCourseTime, setNewCourseTime] = useState('');
  const [newCoursePassword, setNewCoursePassword] = useState('');
  const [selectedSubject, setSelectedSubject] = useState('');

  const [instructorCompany, setInstructorCompany] = useState('');
  const [instructorId, setInstructorId] = useState('');
  const [instructorName, setInstructorName] = useState('');
  const [instructorLocation, setInstructorLocation] = useState('');
  const instructorSigRef = useRef<HTMLCanvasElement | null>(null);
  const instructorPad = useRef<SignaturePad | null>(null);

  const [traineeTeam, setTraineeTeam] = useState('');
  const [traineeId, setTraineeId] = useState('');
  const [traineeName, setTraineeName] = useState('');
  const traineeSigRef = useRef<HTMLCanvasElement | null>(null);
  const traineePad = useRef<SignaturePad | null>(null);
  const [trainees, setTrainees] = useState<Trainee[]>([]);

  const [lectureDate, setLectureDate] = useState('');
  const [submittedDate, setSubmittedDate] = useState('');
  const [submissionTimestamp, setSubmissionTimestamp] = useState('');
  const [instructorSignature, setInstructorSignature] = useState<string>('');

  const [submittedCourses, setSubmittedCourses] = useState<{ [courseName: string]: boolean }>({});

   const [isSubmitted, setIsSubmitted] = useState(false);

  // ‚úÖ Ï¥àÍ∏∞ subject Î∂àÎü¨Ïò§Í∏∞
  useEffect(() => {
  if (selectedMode) {
    loadSubjectsFromFirebase(selectedMode, setSubjectList, setSubjectContents);
    loadCoursesFromFirebase(
      selectedMode,
      setCourseList,
      setCoursePasswords,
      setCourseTimePerCourse,
      setCourseCreatedDates,
      setTraineeListPerCourse,
      setCourseSubjects
    );
  }
}, [selectedMode]);
  
  const resizeCanvas = (canvas: HTMLCanvasElement, width = 400, height = 400) => {
  const ratio = window.devicePixelRatio || 1;
  canvas.width = width * ratio;
  canvas.height = height * ratio;
  canvas.style.width = `${width}px`;
  canvas.style.height = `${height}px`;
  const context = canvas.getContext('2d');
  if (context) {
    context.scale(ratio, ratio);
  }
};

  // ÌôîÎ©¥ Ï†ÑÌôò Ïãú SignaturePad Ï¥àÍ∏∞Ìôî
  useEffect(() => {
  if (screen === 'instructor') {
    if (instructorSigRef.current) {
      instructorPad.current = new SignaturePad(instructorSigRef.current);
      resizeCanvas(instructorSigRef.current);
      instructorPad.current.clear();
    }
    if (traineeSigRef.current) {
      traineePad.current = new SignaturePad(traineeSigRef.current);
      resizeCanvas(traineeSigRef.current);
      traineePad.current.clear();
    }

    if (selectedCourse && traineeListPerCourse[selectedCourse]) {
      setTrainees(traineeListPerCourse[selectedCourse]);
    } else {
      setTrainees([]);
    }

    // üîπ Í∏∞Ï°¥ Ï¥àÍ∏∞Ìôî Ìï≠Î™©
    setInstructorCompany('');
    setInstructorId('');
    setInstructorName('');
    setSubmissionTimestamp('');

    // üîπ Ï∂îÍ∞Ä Ï¥àÍ∏∞Ìôî Ìï≠Î™©
    setInstructorLocation('');
    setLectureDate('');
    setSubmittedDate('');
  }
}, [screen, selectedCourse]);

  // Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
  const handleAdminConfirm = () => {
    if (adminCode === ADMIN_PASSWORD) {
      setShowAdminAuth(false);
      setAdminCode('');
      setScreen('adminHome');
    } else {
      alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.');
    }
  };

  // Í≥ºÎ™© Ï∂îÍ∞Ä
  const handleAddSubject = async () => {
    if (!newSubjectName) return alert('Please enter a subject name.');
    if (!subjectContent) return alert('Please enter subject content.');

    const updatedList = [...subjectList, newSubjectName];
    const updatedContents = { ...subjectContents, [newSubjectName]: subjectContent };

    setSubjectList(updatedList);
    setSubjectContents(updatedContents);
    setNewSubjectName('');
    setSubjectContent('');
    alert('Subject added successfully.');

    // ‚úÖ FirebaseÏóê Ï†ÄÏû•
    await saveSubjectsToFirebase(selectedMode!, updatedList, updatedContents);
  };

  // Í≥ºÎ™© ÏÑ†ÌÉù Ïãú ÎÇ¥Ïö© Î°úÎìú
  const handleSelectSubjectToEdit = (subject: string) => {
    setSelectedSubjectToEdit(subject);
    setSubjectContent(subjectContents[subject] || '');
  };

  // Í≥ºÎ™© ÎÇ¥Ïö© ÏàòÏ†ï
  const handleEditSubject = () => {
    if (!selectedSubjectToEdit) return alert('ÏàòÏ†ïÌï† Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
    setSubjectContents(prev => ({ ...prev, [selectedSubjectToEdit]: subjectContent }));
    alert('Í≥ºÎ™© ÎÇ¥Ïö©Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
  };

  // Í≥ºÎ™© ÏÇ≠Ï†ú
  const handleDeleteSubject = async () => {
  if (!selectedSubjectToEdit) return alert("ÏÇ≠Ï†úÌï† Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
  if (!selectedMode) return alert("Î™®ÎìúÎ•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");

  const confirmDelete = confirm(`${selectedSubjectToEdit} Í≥ºÎ™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
  if (!confirmDelete) return;

  try {
    // **UI ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏**
    const updatedList = subjectList.filter((s) => s !== selectedSubjectToEdit);
    const updatedContents = { ...subjectContents };
    delete updatedContents[selectedSubjectToEdit];

    // **Firestore Ï†ÑÏ≤¥ Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏**
    await saveSubjectsToFirebase(selectedMode, updatedList, updatedContents);

    setSubjectList(updatedList);
    setSubjectContents(updatedContents);
    setSelectedSubjectToEdit("");
    setSubjectContent("");

    alert(`${selectedSubjectToEdit} Í≥ºÎ™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
  } catch (error) {
    console.error("Error deleting subject:", error);
    alert("Í≥ºÎ™© ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
  }
};

  // Í≥ºÏ†ï ÏÉùÏÑ±
  const handleCreateCourse = async () => {
  if (!newCourseName || !newCourseTime || !newCoursePassword) {
    return alert("Please enter the course name, duration, and password.");
  }
  if (!selectedSubject) return alert("Please select a subject.");

  setCourseList(prev => [...prev, newCourseName]);
  setCoursePasswords(prev => ({ ...prev, [newCourseName]: newCoursePassword }));
  setCourseCreatedDates(prev => ({ ...prev, [newCourseName]: new Date().toLocaleDateString() }));
  setCourseTimePerCourse(prev => ({ ...prev, [newCourseName]: newCourseTime }));
  setCourseSubjects(prev => ({ ...prev, [newCourseName]: selectedSubject }));

  // **Firestore Ï†ÄÏû• Ï∂îÍ∞Ä**
  await saveCourseToFirebase(selectedMode!, newCourseName, newCoursePassword, newCourseTime, selectedSubject);

  setNewCourseName('');
  setNewCourseTime('');
  setNewCoursePassword('');
  setSelectedSubject('');
  alert('Í≥ºÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
};

  // ---------- ÏàòÍ∞ïÏÉù Ï∂îÍ∞Ä ----------
    const handleAddTrainee = async () => {
  // üîπ Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ ÏãúÏûë
  if (trainees.length >= 15) {
    return alert('You can register up to 15 participants only.');
  }
  // üîπ Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ ÎÅù

  if (!traineeTeam || !traineeId || !traineeName) {
    return alert("Please enter the trainee's team, ID, and name.");
  }
  if (!traineePad.current || traineePad.current.isEmpty()) {
    return alert("Please provide the trainee's signature.");
  }

  const sigData = traineePad.current.toDataURL();
  const newList = [...trainees, { team: traineeTeam, id: traineeId, name: traineeName, signature: sigData }];

  setTrainees(newList);

  if (selectedCourse) {
    setTraineeListPerCourse(prev => ({ ...prev, [selectedCourse]: newList }));
    await saveTraineesToFirebase(selectedMode!, selectedCourse, newList);
  }

  setTraineeTeam('');
  setTraineeId('');
  setTraineeName('');
  traineePad.current.clear();
};

  // ---------- ÏàòÍ∞ïÏÉù Í¥ÄÎ¶¨ ----------
  // ÏàòÍ∞ïÏÉù Î™©Î°ù Î≥¥Í∏∞
    const handleDeleteTrainee = async (idx: number) => {
    const newList = trainees.filter((_, i) => i !== idx);
    setTrainees(newList);
    if (selectedCourse) {
      setTraineeListPerCourse(prev => ({ ...prev, [selectedCourse]: newList }));
      await saveTraineesToFirebase(selectedMode!, selectedCourse, newList);
    }
  };

  const handleClearTrainees = async () => {
    setTrainees([]);
    if (selectedCourse) {
      setTraineeListPerCourse(prev => ({ ...prev, [selectedCourse]: [] }));
      await saveTraineesToFirebase(selectedMode!, selectedCourse, []);
    }
  };


    // ÏÑúÎ™Ö ÌõÑ Ï†úÏ∂ú
    const handleSubmit = () => {
      if (!instructorCompany || !instructorId || !instructorName) {
        return alert('Please enter the company name, employee ID, and name.');
      }
      if (trainees.length === 0) {
        return alert('At least one trainee is required.');
      }
      if (!instructorPad.current || instructorPad.current.isEmpty()) {
        return alert('Please provide the instructor\'s signature.');
      }
      if (!lectureDate) {
        alert("Please enter the lecture date.");
        return;
      }

      // ‚úÖ ÏÑúÎ™Ö Ï†ÄÏû•
      const sigData = instructorPad.current.toDataURL();
      setInstructorSignature(sigData);
      setSubmissionTimestamp(new Date().toLocaleString());
      instructorPad.current.clear();

      setIsSubmitted(true);   // ‚úÖ Ï†úÏ∂ú ÌõÑ Îã§Ïö¥Î°úÎìú Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏÉÅÌÉú Î≥ÄÍ≤Ω
      setSubmittedCourses(prev => ({ ...prev, [selectedCourse]: true })); // ‚úÖ Ï∂îÍ∞Ä
      alert('SESSION SUBMITTED!');
    };

  // ÏóëÏÖÄ ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
  const exportToExcel = async () => {
  if (!selectedSubject || !subjectContents[selectedSubject]) {
    alert('Í≥ºÎ™© Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.');
    return;
  }
  if (!lectureDate) {
    alert('Í∞ïÏùò ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }

  // Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤ΩÏóêÏÑúÎäî fetchÎ°ú public Í≤ΩÎ°úÏùò ÌÖúÌîåÎ¶ø ÌååÏùº Î°úÎìú
  const workbook = new ExcelJS.Workbook();
  const response = await fetch('/template.xlsx');
  const arrayBuffer = await response.arrayBuffer();
  await workbook.xlsx.load(arrayBuffer);
  const worksheet = workbook.worksheets[0];
  const courseTime = courseTimePerCourse[selectedCourse] || newCourseTime || '';
  const submitted = submittedDate || new Date().toLocaleDateString();

 // ‚úÖ Í¥ÄÎ¶¨Ïûê/Í∞ïÏÇ¨Ïö© ÏûÖÎ†•
  worksheet.getCell('B3').value = selectedSubject;
  worksheet.getCell('B4').value = subjectContents[selectedSubject];
  worksheet.getCell('F5').value = courseTime;
  worksheet.getCell('B5').value = lectureDate;
  worksheet.getCell('C27').value = submitted;
  
  worksheet.getCell('I5').value = instructorLocation;
  worksheet.getCell('B7').value = instructorCompany || '';
  worksheet.getCell('F7').value = instructorId || '';
  worksheet.getCell('I7').value = instructorName || '';

  worksheet.getCell('F8').value = selectedCourse ? selectedCourse : '';

    // üîÑ Í∞ïÏÇ¨ ÏÑúÎ™Ö Ï∂îÍ∞Ä
    if (instructorSignature) {
      const image = workbook.addImage({ base64: instructorSignature, extension: 'png' });
      worksheet.addImage(image, 'I27:I27');
    }

  // ‚úÖ ÏàòÍ∞ïÏÉù ÏûÖÎ†• (ÏÑúÎ™Ö Ìè¨Ìï®)
  trainees.forEach((trainee, index) => {
    const row = 10 + index;
    worksheet.getCell(`A${row}`).value = trainee.team;
    worksheet.getCell(`C${row}`).value = trainee.id;
    worksheet.getCell(`E${row}`).value = trainee.name;

    if (trainee.signature) {
      const image = workbook.addImage({ base64: trainee.signature, extension: 'png' });
      worksheet.addImage(image, `H${row}:H${row}`);
    }
  });

  const buffer = await workbook.xlsx.writeBuffer();
  saveAs(new Blob([buffer]), 'training_output.xlsx');
};

  // TODO: ÏóëÏÖÄ ÏÉùÏÑ± Ìï®Ïàò
  const generateCourseExcel = async (course: string) => {
    if (!course) return;

    const workbook = new ExcelJS.Workbook();
    const response = await fetch('/template.xlsx');
    const arrayBuffer = await response.arrayBuffer();
    await workbook.xlsx.load(arrayBuffer);
    const worksheet = workbook.worksheets[0];

      // Í∞ïÏÇ¨/ÏàòÍ∞ïÏÉù Îç∞Ïù¥ÌÑ∞Îäî ÌòÑÏû¨ ÏÉÅÌÉúÍ∞íÏùÑ Í∏∞Î∞òÏúºÎ°ú Í∞ÄÏ†∏Ïò¥
    const subjectName = courseSubjects[course] || selectedSubject || course;
    const subjectContent = subjectContents[subjectName] || '';
    const courseTime = courseTimePerCourse[course] || newCourseTime || '';
    const dateStr = lectureDate || new Date().toLocaleDateString();
    const traineesInCourse = traineeListPerCourse[course] || trainees;


    // üìå Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†•
    worksheet.getCell('B3').value = subjectName;
    worksheet.getCell('B4').value = subjectContent;
    worksheet.getCell('F5').value = courseTime;
    worksheet.getCell('B5').value = dateStr;
    worksheet.getCell('C27').value = submittedDate || new Date().toLocaleDateString(); // Ï†úÏ∂úÏùº
    worksheet.getCell('I5').value = instructorLocation; // ÏúÑÏπò

    worksheet.getCell('B7').value = instructorCompany;
    worksheet.getCell('F7').value = instructorId;
    worksheet.getCell('I7').value = instructorName;

    worksheet.getCell('F8').value = course;  // ÏóÖÏ≤¥Î™Ö(Í≥ºÏ†ïÎ™Ö) ÏûÖÎ†•

// ‚úÖ Í∞ïÏÇ¨ ÏÑúÎ™Ö Ïù¥ÎØ∏ÏßÄ ÏÇΩÏûÖ
if (instructorSignature) {
  const image = workbook.addImage({ base64: instructorSignature, extension: 'png' });

  // Ìñâ ÎÜíÏù¥ÎèÑ ÏÑ§Ï†ï (ÏóëÏÖÄÏóêÏÑú Î≥¥Í∏∞ Ï¢ãÍ≤å)
  worksheet.getRow(27).height = 81.9;

  worksheet.addImage(image, {
    tl: { col: 8, row: 26 }, // I27 ÏÖÄ
    ext: { width: 287, height: 109 },
    editAs: 'oneCell',
  });
}

// üîÑ ÏàòÍ∞ïÏÉù Ï†ïÎ≥¥ + ÏÑúÎ™Ö Ïù¥ÎØ∏ÏßÄ ÏÇΩÏûÖ
traineesInCourse.forEach((trainee, index) => {
  const row = 10 + index;

  worksheet.getCell(`A${row}`).value = trainee.team;
  worksheet.getCell(`C${row}`).value = trainee.id;
  worksheet.getCell(`E${row}`).value = trainee.name;

  // Ìñâ ÎÜíÏù¥ ÏÑ§Ï†ï
  worksheet.getRow(row).height = 24.9;

  if (trainee.signature) {
    const image = workbook.addImage({ base64: trainee.signature, extension: 'png' });

    worksheet.addImage(image, {
      tl: { col: 7, row: row - 1 }, // HÏó¥ (0-indexed)
      ext: { width: 184, height: 33 },
      editAs: 'oneCell',
    });
  }
});

    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), `${course}_Ï†ÑÏ≤¥Ï†ïÎ≥¥.xlsx`);
  };

  // Í≥ºÏ†ï ÏÇ≠Ï†ú Í∏∞Îä•
  const handleDeleteCourse = async (course: string) => {
  if (confirm(`${course} Í≥ºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
    const updatedList = courseList.filter(c => c !== course);
    const updatedPasswords = { ...coursePasswords };
    const updatedDates = { ...courseCreatedDates };
    const updatedTimes = { ...courseTimePerCourse };
    const updatedSubjects = { ...courseSubjects };
    
    delete updatedPasswords[course];
    delete updatedDates[course];
    delete updatedTimes[course];
    delete updatedSubjects[course];

    setCourseList(updatedList);
    setCoursePasswords(updatedPasswords);
    setCourseCreatedDates(updatedDates);
    setCourseTimePerCourse(updatedTimes);
    setCourseSubjects(updatedSubjects);

    // **Firebase Î∞òÏòÅ**
    const collectionName = selectedMode === "domestic" ? "course_domestic" : "course_overseas";
    await deleteDoc(doc(db, collectionName, course));

    alert(`${course} Í≥ºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
  }
};

  // UI Íµ¨ÏÑ± ÏãúÏûë
  // Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥
  if (!selectedMode) {
    return (
      <div className="flex flex-col items-center justify-center h-screen space-y-6">
        <h1 className="text-2xl font-bold">Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h1>
        <button
          className="bg-blue-500 text-white px-6 py-3 rounded"
          onClick={() => setSelectedMode("overseas")}
        >
          Ìï¥Ïô∏ÏúÑÌÉÅ Î™®Îìú
        </button>
        <button
          className="bg-green-500 text-white px-6 py-3 rounded"
          onClick={() => setSelectedMode("domestic")}
        >
          Íµ≠ÎÇ¥ Î™®Îìú
        </button>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      {/* Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Î™®Îã¨ */}
      {showAdminAuth && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white p-6 rounded shadow-md w-80">
            <h2 className="text-lg font-bold mb-4">Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù</h2>
            <input
              type="password"
              className="border p-2 w-full mb-4"
              placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (4ÏûêÎ¶¨)"
              maxLength={4}
              value={adminCode}
              onChange={e => setAdminCode(e.target.value)}
            />
            <div className="flex justify-end space-x-2">
              <button
                className="bg-gray-300 px-4 py-2 rounded"
                onClick={() => { setShowAdminAuth(false); setAdminCode(''); }}
              >
                Ï∑®ÏÜå
              </button>
              <button
                className="bg-blue-500 text-white px-4 py-2 rounded"
                onClick={handleAdminConfirm}
              >
                ÌôïÏù∏
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Í∞ïÏÇ¨ Ïù∏Ï¶ù Î™®Îã¨ */}
      {showInstructorAuth && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white p-6 rounded shadow-md w-80">
            <h2 className="text-lg font-bold mb-4">Course Password</h2>
            <input
              type="password"
              className="border p-2 w-full mb-4"
              placeholder="Enter password"
              value={instructorCode}
              onChange={e => setInstructorCode(e.target.value)}
            />
            <div className="flex justify-end space-x-2">
            <button
              className="bg-gray-300 px-4 py-2 rounded"
              onClick={() => { setShowInstructorAuth(false); setInstructorCode(''); }}
            >
              Cancel
            </button>
            <button
              className="bg-blue-500 text-white px-4 py-2 rounded"
              onClick={() => {
                if (coursePasswords[selectedCourse] === instructorCode) {
                  setShowInstructorAuth(false);
                  setInstructorCode('');
                  setScreen('instructor');
                } else {
                  alert('Incorrect password.');
                }
              }}
            >
              Ok
            </button>
            </div>
          </div>
        </div>
      )}

      {/* Î©îÏù∏ ÌôîÎ©¥ */}
      {screen === 'main' && (
        <div className="flex flex-col items-center space-y-8 mt-10">
          <button
            className="w-64 h-16 bg-orange-500 text-white text-xl rounded"
            onClick={() => { setShowInstructorAuth(false); setShowAdminAuth(true); }}
          >
            Admin Mode
          </button>

          <select
            className="w-64 h-12 border text-left"
            value={selectedCourse}
            onChange={e => setSelectedCourse(e.target.value)}
          >
            <option value="">Select Course</option>
            {courseList.map((course) => (
            <option key={course} value={course}>
              {course} ({courseSubjects[course] || 'No Subject'})
            </option>
          ))}
          </select>

          <button
            className="w-64 h-16 bg-blue-500 text-white text-xl rounded"
            onClick={() => {
              if (!selectedCourse) {
                alert('Please select a course first.');
                return;
              }
              setShowAdminAuth(false);
              setShowInstructorAuth(true);
            }}
          >
            Instructor Mode
          </button>

          <button
            className="bg-gray-500 text-white px-4 py-2 rounded mt-4"
            onClick={() => {
              setSelectedMode(null);
              setScreen('main');
            }}
          >
            Íµ≠ÎÇ¥/Ìï¥Ïô∏ ÏÑ†ÌÉùÌôîÎ©¥ÏúºÎ°ú
          </button>
        </div>
      )}

      {/* Step 1: Í¥ÄÎ¶¨Ïûê Ìôà ÌôîÎ©¥ */}
      {screen === 'adminHome' && (
  <div className="space-y-6 mt-8">
    <h2 className="text-2xl font-bold">Í¥ÄÎ¶¨Ïûê Ìôà</h2>
    <div className="flex space-x-4">
      <button
        className="bg-green-500 text-white px-4 py-2 rounded"
        onClick={() => setScreen('createCourse')}
      >
        ÏúÑÌÉÅÏóÖÏ≤¥ ÏÉùÏÑ±
      </button>
      <button
        className="bg-pink-500 text-white px-4 py-2 rounded"
        onClick={() => setScreen('editCourse')}
      >
        SUBJECT CONTENTS Ï∂îÍ∞Ä/ÏàòÏ†ï  
      </button>
    </div>

    {/* ‚úÖ ÏÉùÏÑ±Îêú ÏóÖÏ≤¥ Î™©Î°ù (Îã§Ïö¥Î°úÎìú Î∞è ÏÇ≠Ï†úÎßå Í∞ÄÎä•) */}
    <div className="mt-6 space-y-2">
      <h3 className="text-lg font-semibold">ÏÉùÏÑ±Îêú ÏóÖÏ≤¥ Î™©Î°ù</h3>
      {courseList.map((course, idx) => (
        <div key={idx} className="flex justify-between items-center p-2 border rounded">
          <div>
            <div className="font-semibold">
            {course} ({courseSubjects[course] || "No Subject"})
          </div>
          <div className="text-sm text-gray-500">
            ÏÉùÏÑ±Ïùº: {courseCreatedDates[course] || 'N/A'}
          </div>
          </div>
          <div className="flex space-x-2">
           {submittedCourses[course] ? (
            <button
              className="bg-blue-500 text-white px-3 py-1 rounded text-sm"
              onClick={() => generateCourseExcel(course)}
            >
              Îã§Ïö¥Î°úÎìú
            </button>
          ) : (
            <span className="text-gray-500 text-sm">Ï†úÏ∂ú Ï†Ñ</span>
          )}
            <button
              className="bg-red-500 text-white px-3 py-1 rounded text-sm"
              onClick={async () => {
                if (window.confirm(`${course} ÏóÖÏ≤¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                  setCourseList(prev => prev.filter(c => c !== course));
                  setCoursePasswords(prev => {
                    const copy = { ...prev };
                    delete copy[course];
                    return copy;
                  });
                  setCourseCreatedDates(prev => {
                    const copy = { ...prev };
                    delete copy[course];
                    return copy;
                  });
                  setCourseTimePerCourse(prev => {
                    const copy = { ...prev };
                    delete copy[course];
                    return copy;
                  });
                  setCourseSubjects(prev => {
                    const copy = { ...prev };
                    delete copy[course];
                    return copy;
                  });
                  setTraineeListPerCourse(prev => {
                    const copy = { ...prev };
                    delete copy[course];
                    return copy;
                  });

                  // **Firebase Î∞òÏòÅ**
                 const collectionName = selectedMode === "domestic" ? "course_domestic" : "course_overseas";
                  await deleteDoc(doc(db, collectionName, course));

                  alert(`${course} Í≥ºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                }
              }}
            >
              ÏÇ≠Ï†ú
            </button>
          </div>
        </div>
      ))}
    </div>

    <button
      className="bg-gray-400 text-white px-4 py-2 rounded"
      onClick={() => setScreen('main')}
    >
      Î©îÏù∏ÌôîÎ©¥ÏúºÎ°ú
    </button>
  </div>
)}

    {/* Step 2: Í≥ºÏ†ï ÏÉùÏÑ± ÌôîÎ©¥ */}
    {screen === 'createCourse' && (
      <div className="mt-8 space-y-4">
        <h2 className="text-xl font-bold">ÏúÑÌÉÅÏóÖÏ≤¥ ÏÉùÏÑ±</h2>
        <input
          className="border p-2 w-full"
          placeholder="ÏóÖÏ≤¥Î™Ö"
          value={newCourseName}
          onChange={e => setNewCourseName(e.target.value)}
        />
        <input
          className="border p-2 w-full"
          placeholder="ÍµêÏú°ÏãúÍ∞Ñ"
          value={newCourseTime}
          onChange={e => setNewCourseTime(e.target.value)}
        />
        <input
          className="border p-2 w-full"
          placeholder="ÏóÖÏ≤¥ Í∞ïÏÇ¨Ïö© ÎπÑÎ∞ÄÎ≤àÌò∏"
          value={newCoursePassword}
          onChange={e => setNewCoursePassword(e.target.value)}
        />
        <select
          className="border p-2 w-full"
          value={selectedSubject}
          onChange={e => setSelectedSubject(e.target.value)}
        >
          <option value="">SUBJECT ÏÑ†ÌÉù</option>
          {subjectList.map((subj, idx) => (
            <option key={idx} value={subj}>{subj}</option>
          ))}
        </select>
        <div className="flex space-x-2">
          <button
            className="bg-blue-500 text-white px-4 py-2 rounded flex-1"
            onClick={handleCreateCourse}
          >
            ÏÉùÏÑ±
          </button>
          <button
            className="bg-gray-400 text-white px-4 py-2 rounded flex-1"
            onClick={() => setScreen('adminHome')}
          >
            Îí§Î°úÍ∞ÄÍ∏∞
          </button>
        </div>
      </div>
    )}

    {/* Step 3: SUBJECT ÏàòÏ†ï ÌôîÎ©¥ */}
      {screen === 'editCourse' && (
        <div className="mt-8 space-y-4">
          <h2 className="text-xl font-bold">SUBJECT Í¥ÄÎ¶¨</h2>
          <input
            className="border p-2 w-full"
            placeholder="ÏÉà SUBJECTÎ™Ö"
            value={newSubjectName}
            onChange={e => setNewSubjectName(e.target.value)}
          />
          <textarea
            className="border p-2 w-full h-24"
            placeholder="CONTENT ÎÇ¥Ïö©"
            value={subjectContent}
            onChange={e => setSubjectContent(e.target.value)}
          />
          <div className="flex space-x-2">
            <button
              className="bg-green-500 text-white px-4 py-2 rounded flex-1"
              onClick={handleAddSubject}
            >
              Ï∂îÍ∞Ä
            </button>
            <button
              className="bg-yellow-500 text-white px-4 py-2 rounded flex-1"
              onClick={handleEditSubject}
            >
              ÏàòÏ†ï
            </button>
            <button
              className="bg-red-500 text-white px-4 py-2 rounded flex-1"
              onClick={handleDeleteSubject}
            >
              ÏÇ≠Ï†ú
            </button>
          </div>
          <select
            className="border p-2 w-full"
            value={selectedSubjectToEdit}
            onChange={e => handleSelectSubjectToEdit(e.target.value)}
          >
            <option value="">SUBJECT ÏÑ†ÌÉù</option>
            {subjectList.map((subj, idx) => (
              <option key={idx} value={subj}>{subj}</option>
            ))}
          </select>
          <button
            className="bg-gray-400 text-white px-4 py-2 rounded w-full"
            onClick={() => setScreen('adminHome')}
          >
            Îí§Î°úÍ∞ÄÍ∏∞
          </button>       
        </div>
      )}

    {/* Step 4: Í∞ïÏÇ¨ ÌôîÎ©¥ */}
      {screen === 'instructor' && (
        <div className="mt-8 space-y-6">
          <h2 className="text-2xl font-bold text-center">Instructor Mode</h2>

          <div className="bg-gray-100 p-4 rounded space-y-4">
            <h3 className="text-lg font-semibold">Instructor INFO</h3>
            <input className="border p-2 w-mt2" placeholder="Company Name" value={instructorCompany} onChange={e => setInstructorCompany(e.target.value)} />
            <input className="border p-2 w-mt2" placeholder="Employee ID" value={instructorId} onChange={e => setInstructorId(e.target.value)} />
            <input className="border p-2 w-mt2" placeholder="Name" value={instructorName} onChange={e => setInstructorName(e.target.value)} />
            <input className="border p-2 w-mt2" placeholder="Location" value={instructorLocation} onChange={e => setInstructorLocation(e.target.value)} />
            <label className="block">Signature</label>
            <canvas ref={instructorSigRef}  className="border-2 border-gray-700 bg-white w-full max-w-md aspect-square rounded"
/>
            <button className="bg-gray-400 text-white w-full py-2 rounded" onClick={() => instructorPad.current?.clear()}>Signature Reset</button>
          </div>

          <div className="bg-gray-100 p-4 rounded space-y-4">
            <h3 className="text-lg font-semibold">Trainee INFO</h3>
            <input className="border p-2 w-mt2" placeholder="Team" value={traineeTeam} onChange={e => setTraineeTeam(e.target.value)} />
            <input className="border p-2 w-mt2" placeholder="Employee ID" value={traineeId} onChange={e => setTraineeId(e.target.value)} />
            <input className="border p-2 w-mt2" placeholder="Name" value={traineeName} onChange={e => setTraineeName(e.target.value)} />
            <label className="block">Signature</label>
            <canvas ref={traineeSigRef}  className="border-2 border-gray-700 bg-white w-full max-w-md aspect-square rounded"
/>
            <button className="bg-gray-400 text-white w-full py-2 rounded" onClick={() => traineePad.current?.clear()}>Signature Reset</button>
            <button className="bg-green-500 text-white w-full py-2 rounded" onClick={handleAddTrainee}>Add Trainee</button>
          </div>

          <div className="bg-white p-4 rounded border text-center">
            <h3 className="text-lg font-semibold mb-2">Trainee Status</h3>
            <p className="text-xl">{trainees.length} Completed</p>
            <button
              className="bg-blue-500 text-white w-full py-2 rounded mt-2"
              onClick={() => setScreen('traineeList')}
            >
              View All Trainees
            </button>
          </div>

          <div className="flex space-x-2 items-end">
            <div className="flex-1">
              <label className="block font-medium mb-1">Lecture Date</label>
              <input
                type="text"
                placeholder=""
                className="border p-2 w-full"
                value={lectureDate}
                onChange={e => setLectureDate(e.target.value)}
              />
              <input
                className="border p-2 w-full"
                placeholder="SubmittedDate"
                value={submittedDate}
                onChange={e => setSubmittedDate(e.target.value)}
              />
            </div>

            <button
              className="bg-yellow-400 text-black w-1/2 py-2 rounded"
              onClick={handleSubmit}
            >
              Submit
            </button>
          </div>

          <button
            className="bg-gray-400 text-white w-full py-2 rounded mt-2"
            onClick={() => setScreen('main')}
          >
            Main Menu
          </button>
        </div>
      )}

      {/* Step 5: Trainee List Screen */}
        {screen === 'traineeList' && (
        <div className="mt-8 space-y-6">
          <h2 className="text-2xl font-bold text-center">All Trainees</h2>

      <ul className="space-y-2 border p-4 rounded bg-white">
        {trainees.length === 0 ? (
          <p>No trainees registered.</p>
        ) : (
          trainees.map((t, idx) => (
            <li key={idx} className="flex justify-between items-center border-b pb-1">
              <span>{t.team} / {t.id} / {t.name}</span>
              <button
                onClick={() => handleDeleteTrainee(idx)}
                className="text-sm text-red-500"
              >
                Delete
              </button>
            </li>
          ))
        )}
      </ul>

    {/* ‚úÖ Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Î≤ÑÌäº Ï∂îÍ∞Ä */}
    {trainees.length > 0 && (
      <button
        className="bg-red-500 text-white w-full py-2 rounded"
        onClick={handleClearTrainees}
      >
        Delete All Trainees
      </button>
    )}

    <button
      className="bg-gray-400 text-white w-full py-2 rounded"
      onClick={() => setScreen('instructor')}
    >
      Back
    </button>
  </div>
)}
    </div>
  );
} 
